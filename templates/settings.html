{% extends "base.html" %}

{% block title %}Settings - File Fridge{% endblock %}

{% block content %}
<div class="row">
    <div class="col-12">
        <h1 class="mb-4">
            <i class="bi bi-gear me-2"></i>Settings
        </h1>
    </div>
</div>

<div class="row">
    <!-- Settings Navigation -->
    <div class="col-md-3 mb-4">
        <div class="list-group" id="settings-nav">
            <a href="#accounts" class="list-group-item list-group-item-action active" data-section="accounts">
                <i class="bi bi-person-circle me-2"></i>Accounts
            </a>
            <a href="#remote-connections" class="list-group-item list-group-item-action" data-section="remote-connections">
                <i class="bi bi-hdd-network me-2"></i>Remote Connections
            </a>
            <a href="#encryption" class="list-group-item list-group-item-action" data-section="encryption">
                <i class="bi bi-shield-lock me-2"></i>Encryption
            </a>
        </div>
    </div>

    <!-- Settings Content -->
    <div class="col-md-9">
        <!-- Accounts Section -->
        <div id="accounts-section" class="settings-section">
        <div id="accounts" class="card mb-4">
            <div class="card-header">
                <h5 class="mb-0">
                    <i class="bi bi-person-circle me-2"></i>Account Settings
                </h5>
            </div>
            <div class="card-body">
                <div class="mb-4">
                    <h6 class="text-muted">Change Password</h6>
                    <p class="text-muted small">
                        Change your password by entering your current password and a new one below.
                    </p>

                    <form id="change-password-form">
                        <div class="mb-3">
                            <label for="old-password" class="form-label">Current Password</label>
                            <div class="input-group">
                                <span class="input-group-text">
                                    <i class="bi bi-lock"></i>
                                </span>
                                <input type="password" class="form-control" id="old-password"
                                       name="old_password" required minlength="1"
                                       placeholder="Enter your current password"
                                       autocomplete="current-password">
                            </div>
                        </div>

                        <div class="mb-3">
                            <label for="new-password" class="form-label">New Password</label>
                            <div class="input-group">
                                <span class="input-group-text">
                                    <i class="bi bi-key"></i>
                                </span>
                                <input type="password" class="form-control" id="new-password"
                                       name="new_password" required minlength="8"
                                       placeholder="Enter your new password (minimum 8 characters)"
                                       autocomplete="new-password">
                                <button class="btn btn-outline-secondary" type="button" id="toggle-password">
                                    <i class="bi bi-eye" id="toggle-icon"></i>
                                </button>
                            </div>
                            <div class="form-text">Password must be at least 8 characters long.</div>
                        </div>

                        <div class="mb-3">
                            <label for="confirm-password" class="form-label">Confirm New Password</label>
                            <div class="input-group">
                                <span class="input-group-text">
                                    <i class="bi bi-key-fill"></i>
                                </span>
                                <input type="password" class="form-control" id="confirm-password"
                                       name="confirm_password" required minlength="8"
                                       placeholder="Confirm your new password"
                                       autocomplete="new-password">
                            </div>
                        </div>

                        <div class="alert alert-info d-none" id="password-strength" role="alert">
                            <i class="bi bi-info-circle me-2"></i>
                            <span id="password-strength-text"></span>
                        </div>

                        <div class="d-grid gap-2 d-md-flex justify-content-md-end">
                            <button type="submit" class="btn btn-primary" id="submit-btn">
                                <span id="submit-text">
                                    <i class="bi bi-check-circle me-2"></i>Change Password
                                </span>
                                <span id="submit-spinner" class="d-none">
                                    <span class="spinner-border spinner-border-sm me-2" role="status" aria-hidden="true"></span>
                                    Changing...
                                </span>
                            </button>
                        </div>
                    </form>

                    <div id="error-message" class="alert alert-danger mt-3 d-none" role="alert">
                        <i class="bi bi-exclamation-triangle me-2"></i>
                        <span id="error-text"></span>
                    </div>

                    <div id="success-message" class="alert alert-success mt-3 d-none" role="alert">
                        <i class="bi bi-check-circle me-2"></i>
                        <span id="success-text"></span>
                    </div>
                </div>
            </div>
        </div>
        </div>

        <!-- Remote Connections Section -->
        <div id="remote-connections-section" class="settings-section d-none">
        <div id="remote-connections" class="card mb-4">
            <div class="card-header d-flex justify-content-between align-items-center">
                <h5 class="mb-0">
                    <i class="bi bi-hdd-network me-2"></i>Remote Connections
                </h5>
                <button class="btn btn-sm btn-primary" id="add-remote-btn" data-bs-toggle="modal" data-bs-target="#addConnectionModal">
                    <i class="bi bi-plus-circle me-1"></i>Add Connection
                </button>
            </div>
            <div class="card-body">
                <div class="mb-4">
                    <h6 class="text-muted">Instance Connection Code</h6>
                    <p class="text-muted small">
                        Copy this code to another File Fridge instance to allow it to connect to this server.
                        This code rotates hourly.
                    </p>
                    <div class="input-group mb-3">
                        <input type="text" class="form-control" id="my-connection-code" readonly>
                        <button class="btn btn-outline-secondary" type="button" id="copy-code-btn" title="Copy to clipboard">
                            <i class="bi bi-clipboard"></i>
                        </button>
                        <button class="btn btn-outline-secondary" type="button" id="refresh-code-btn" title="Refresh code">
                            <i class="bi bi-arrow-clockwise"></i>
                        </button>
                    </div>
                </div>

                <div class="table-responsive">
                    <table class="table table-hover">
                        <thead>
                            <tr>
                                <th>Name</th>
                                <th>URL</th>
                                <th>Created</th>
                                <th>Actions</th>
                            </tr>
                        </thead>
                        <tbody id="remote-connections-list">
                            <!-- Connections will be loaded here -->
                            <tr>
                                <td colspan="4" class="text-center text-muted py-4">
                                    <output>
                                        <div class="spinner-border spinner-border-sm me-2" aria-label="Loading"></div>
                                        Loading connections...
                                    </output>
                                </td>
                            </tr>
                        </tbody>
                    </table>
                </div>
            </div>
        </div>

         <div id="remote-transfers" class="card mb-4 mt-4">
            <div class="card-header d-flex justify-content-between align-items-center">
                <h5 class="mb-0">
                    <i class="bi bi-arrow-left-right me-2"></i>Active Transfers
                </h5>
                <div>
                    <button class="btn btn-sm btn-outline-secondary" id="refresh-transfers-btn">
                        <i class="bi bi-arrow-clockwise"></i>
                    </button>
                    <button class="btn btn-sm btn-outline-danger ms-2" id="bulk-cancel-btn" onclick="bulkCancelTransfers()">
                        <i class="bi bi-x-circle me-1"></i>Cancel All Failed
                    </button>
                    <button class="btn btn-sm btn-outline-warning ms-2" id="bulk-retry-btn" onclick="bulkRetryTransfers()">
                        <i class="bi bi-arrow-clockwise me-1"></i>Retry Failed
                    </button>
                </div>
            </div>
            <div class="card-body">
                <div class="table-responsive">
                    <table class="table table-sm table-hover">
                        <thead>
                            <tr>
                                <th>File</th>
                                <th>Status</th>
                                <th>Progress</th>
                                <th>ETA</th>
                                <th>Actions</th>
                            </tr>
                        </thead>
                        <tbody id="remote-transfers-list">
                            <tr>
                                <td colspan="5" class="text-center text-muted py-3">No active transfers.</td>
                            </tr>
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
        </div>

        <!-- Encryption Section -->
        <div id="encryption-section" class="settings-section d-none">
            <div id="encryption" class="card mb-4">
                <div class="card-header d-flex justify-content-between align-items-center">
                    <h5 class="mb-0">
                        <i class="bi bi-shield-lock me-2"></i>Server Encryption Keys
                    </h5>
                    <button class="btn btn-sm btn-primary" id="btn-generate-key">
                        <i class="bi bi-plus-circle me-1"></i>Generate New Key (Rotate)
                    </button>
                </div>
                <div class="card-body">
                    <div class="alert alert-info d-flex align-items-center" role="alert">
                        <i class="bi bi-info-circle-fill me-3 fs-4"></i>
                        <div>
                            Encryption keys are used to secure sensitive data like SMTP passwords and for secure remote transfers.
                            When you generate a new key, it will be added to the list and used for all new encryption operations.
                            Existing data can still be decrypted using older keys in the list.
                        </div>
                    </div>

                    <div class="table-responsive">
                        <table class="table table-hover align-middle">
                            <thead class="table-light">
                                <tr>
                                    <th>ID</th>
                                    <th>Fingerprint (SHA-256)</th>
                                    <th>Created</th>
                                    <th class="text-end">Actions</th>
                                </tr>
                            </thead>
                            <tbody id="encryption-keys-list">
                                <!-- Loaded via JS -->
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Add Connection Modal -->
<div class="modal fade" id="addConnectionModal" tabindex="-1" aria-labelledby="addConnectionModalLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="addConnectionModalLabel">Add Remote Connection</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <form id="add-connection-form">
                <div class="modal-body">
                    <div class="mb-3">
                        <label for="remote-name" class="form-label">Name</label>
                        <input type="text" class="form-control" id="remote-name" name="name" required placeholder="e.g., Home Server">
                    </div>
                    <div class="mb-3">
                        <label for="remote-url" class="form-label">URL</label>
                        <input type="url" class="form-control" id="remote-url" name="url" required placeholder="http://192.168.1.10:8000">
                        <div class="form-text">The full URL of the remote File Fridge instance.</div>
                    </div>
                    <div class="mb-3">
                        <label for="connection-code" class="form-label">Connection Code</label>
                        <input type="text" class="form-control" id="connection-code" name="connection_code" required placeholder="Paste the code from the remote instance">
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                    <button type="submit" class="btn btn-primary" id="save-connection-btn">
                        <span id="save-connection-text">Add Connection</span>
                        <output id="save-connection-spinner" class="d-none">
                            <span class="spinner-border spinner-border-sm me-1" aria-label="Connecting" aria-hidden="true"></span>
                            Connecting...
                        </output>
                    </button>
                </div>
            </form>
        </div>
    </div>
</div>

<!-- Delete Connection Modal -->
<div class="modal fade" id="deleteConnectionModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Delete Connection</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <p>Are you sure you want to delete the connection to <strong id="delete-conn-name"></strong>?</p>
                <p class="text-danger small">This will terminate the shared secret and inter-instance communication.</p>

                <div class="form-check mt-3">
                    <input class="form-check-input" type="checkbox" id="force-delete-check">
                    <label class="form-check-label text-warning" for="force-delete-check">
                        <strong>Force Delete</strong> (Remote instance is unreachable)
                    </label>
                </div>
                <div id="force-delete-warning" class="alert alert-warning mt-2 d-none small">
                    <i class="bi bi-exclamation-triangle me-2"></i>
                    A force delete will require the remote File Fridge server to also force delete from its UI or API.
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                <button type="button" class="btn btn-danger" id="confirm-delete-conn-btn">Delete</button>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_scripts %}
<script src="/static/js/settings.js"></script>
{% endblock %}
