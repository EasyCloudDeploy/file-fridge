{% extends "base.html" %}

{% block title %}{% if editing %}Edit{% else %}Add{% endif %} Criteria - File Fridge{% endblock %}

{% block content %}
<div class="row">
    <div class="col-12 col-md-8 offset-md-2">
        <div class="d-flex justify-content-between align-items-center mb-4">
            <h1>
                <i class="bi bi-{% if editing %}pencil{% else %}plus-circle{% endif %}"></i>
                {% if editing %}Edit{% else %}Add{% endif %} Criteria
            </h1>
            <a href="/paths/{{ path.id }}" class="btn btn-secondary">
                <i class="bi bi-arrow-left"></i> Back to Path
            </a>
        </div>

        <div class="card mb-3">
            <div class="card-body">
                <h5 class="card-title">{{ path.name }}</h5>
                <p class="card-text text-muted mb-0">
                    <code>{{ path.source_path }}</code>
                </p>
            </div>
        </div>

        <div class="card">
            <div class="card-body">
                <form method="post" action="{% if editing %}/criteria/{{ criterion.id }}{% else %}/paths/{{ path.id }}/criteria{% endif %}">
                    <div class="mb-3">
                        <label for="criterion_type" class="form-label">Criteria Type *</label>
                        <select class="form-select" id="criterion_type" name="criterion_type" required>
                            <option value="">Select a type...</option>
                            <option value="mtime" {% if criterion and criterion.criterion_type.value == "mtime" %}selected{% endif %}>Modification Time (mtime)</option>
                            <option value="atime" {% if criterion and criterion.criterion_type.value == "atime" %}selected{% endif %}>Access Time (atime)</option>
                            <option value="ctime" {% if criterion and criterion.criterion_type.value == "ctime" %}selected{% endif %}>Change Time (ctime)</option>
                            <option value="size" {% if criterion and criterion.criterion_type.value == "size" %}selected{% endif %}>File Size</option>
                            <option value="name" {% if criterion and criterion.criterion_type.value == "name" %}selected{% endif %}>Filename (case-sensitive)</option>
                            <option value="iname" {% if criterion and criterion.criterion_type.value == "iname" %}selected{% endif %}>Filename (case-insensitive)</option>
                            <option value="type" {% if criterion and criterion.criterion_type.value == "type" %}selected{% endif %}>File Type</option>
                            <option value="perm" {% if criterion and criterion.criterion_type.value == "perm" %}selected{% endif %}>Permissions</option>
                            <option value="user" {% if criterion and criterion.criterion_type.value == "user" %}selected{% endif %}>User</option>
                            <option value="group" {% if criterion and criterion.criterion_type.value == "group" %}selected{% endif %}>Group</option>
                        </select>
                        <small class="form-text text-muted">
                            The type of file attribute to match against
                        </small>
                    </div>

                    <div class="mb-3">
                        <label for="operator" class="form-label">Operator *</label>
                        <select class="form-select" id="operator" name="operator" required>
                            <option value="">Select an operator...</option>
                            <option value=">" {% if criterion and criterion.operator.value == ">" %}selected{% endif %}>> (Greater Than)</option>
                            <option value="<" {% if criterion and criterion.operator.value == "<" %}selected{% endif %}>< (Less Than)</option>
                            <option value="=" {% if criterion and criterion.operator.value == "=" %}selected{% endif %}>= (Equal To)</option>
                            <option value=">=" {% if criterion and criterion.operator.value == ">=" %}selected{% endif %}>>= (Greater Than or Equal)</option>
                            <option value="<=" {% if criterion and criterion.operator.value == "<=" %}selected{% endif %}><= (Less Than or Equal)</option>
                            <option value="contains" {% if criterion and criterion.operator.value == "contains" %}selected{% endif %}>Contains</option>
                            <option value="matches" {% if criterion and criterion.operator.value == "matches" %}selected{% endif %}>Matches (glob pattern)</option>
                            <option value="regex" {% if criterion and criterion.operator.value == "regex" %}selected{% endif %}>Regex</option>
                        </select>
                        <small class="form-text text-muted">
                            The comparison operator to use
                        </small>
                    </div>

                    <div class="mb-3">
                        <label for="value" class="form-label">Value *</label>
                        <input type="text" class="form-control" id="value" name="value" 
                               value="{% if criterion %}{{ criterion.value }}{% endif %}" required>
                        <small class="form-text text-muted">
                            <div id="value-help">
                                <strong>Examples:</strong><br>
                                <span id="mtime-help" style="display: none;">
                                    Minutes since modification (e.g., "30" for files older than 30 minutes, "1440" for 1 day)
                                </span>
                                <span id="atime-help" style="display: none;">
                                    Minutes since access (e.g., "30" for files older than 30 minutes, "1440" for 1 day)
                                </span>
                                <span id="ctime-help" style="display: none;">
                                    Minutes since change (e.g., "30" for files older than 30 minutes, "1440" for 1 day)
                                </span>
                                <span id="size-help" style="display: none;">
                                    Size with optional suffix: c (bytes), k (KB), M (MB), G (GB)<br>
                                    Example: "100M" for files larger than 100MB, "1G" for files larger than 1GB
                                </span>
                                <span id="name-help" style="display: none;">
                                    Filename pattern (e.g., "*.log", "*.txt", "app*")
                                </span>
                                <span id="type-help" style="display: none;">
                                    File type: "f" or "file" for files, "d" or "directory" for directories, "l" or "link" for symlinks
                                </span>
                                <span id="perm-help" style="display: none;">
                                    Permissions in octal (e.g., "755") or symbolic (e.g., "rwx")
                                </span>
                                <span id="user-help" style="display: none;">
                                    Username or UID (e.g., "www-data" or "33")
                                </span>
                                <span id="group-help" style="display: none;">
                                    Group name or GID (e.g., "www-data" or "33")
                                </span>
                            </div>
                        </small>
                    </div>

                    <div class="mb-3">
                        <div class="form-check">
                            <input class="form-check-input" type="checkbox" id="enabled" name="enabled" 
                                   {% if not criterion or criterion.enabled %}checked{% endif %}>
                            <label class="form-check-label" for="enabled">
                                Enabled
                            </label>
                        </div>
                        <small class="form-text text-muted">
                            Enable or disable this criterion. All enabled criteria must match for a file to be moved.
                        </small>
                    </div>

                    <div class="d-flex justify-content-between">
                        <a href="/paths/{{ path.id }}" class="btn btn-secondary">Cancel</a>
                        <button type="submit" class="btn btn-primary">
                            <i class="bi bi-save"></i> {% if editing %}Update{% else %}Create{% endif %} Criteria
                        </button>
                    </div>
                </form>
            </div>
        </div>

        <div class="card mt-3">
            <div class="card-header">
                <h6 class="mb-0">Criteria Examples</h6>
            </div>
            <div class="card-body">
                <ul class="list-unstyled mb-0">
                    <li><strong>Files older than 30 minutes:</strong> Type: mtime, Operator: >, Value: 30</li>
                    <li><strong>Files older than 1 day (1440 minutes):</strong> Type: mtime, Operator: >, Value: 1440</li>
                    <li><strong>Files larger than 1GB:</strong> Type: size, Operator: >, Value: 1G</li>
                    <li><strong>All .log files:</strong> Type: name, Operator: matches, Value: *.log</li>
                    <li><strong>Files containing "backup":</strong> Type: name, Operator: contains, Value: backup</li>
                    <li><strong>Only files (not directories):</strong> Type: type, Operator: =, Value: f</li>
                </ul>
            </div>
        </div>
    </div>
</div>

<script>
// Show contextual help based on selected criterion type
document.getElementById('criterion_type').addEventListener('change', function() {
    const type = this.value;
    // Hide all help texts
    document.querySelectorAll('#value-help > span').forEach(span => {
        span.style.display = 'none';
    });
    // Show relevant help
    if (type && document.getElementById(type + '-help')) {
        document.getElementById(type + '-help').style.display = 'block';
    }
});

// Trigger on page load if criterion type is already selected
document.addEventListener('DOMContentLoaded', function() {
    const typeSelect = document.getElementById('criterion_type');
    if (typeSelect.value) {
        typeSelect.dispatchEvent(new Event('change'));
    }
});
</script>
{% endblock %}

